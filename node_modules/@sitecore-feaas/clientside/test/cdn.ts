import { describe, it, assert, beforeAll, expect } from 'vitest'
import {
  parseComponentSource,
  getComponentSource,
  DEFAULT_CDN_URL,
  getStylesheetSource,
  parseStylesheetSource,
  getStylesheetURL,
  getComponentURL
} from '../src/cdn.js'
import { CH1Node, serializeCH1RichText } from '../src/utils/data.js'
describe('CDN', function () {
  it('should parse and serialize component src', function () {
    expect(
      parseComponentSource('https://feaaslocal.blob.core.windows.net/components/2rFkpifWzZp5IEhKX4rt5raaaa/bkpRNHFB2v')
    ).toEqual({
      cdn: 'https://feaaslocal.blob.core.windows.net',
      component: 'bkpRNHFB2v',
      library: '2rFkpifWzZp5IEhKX4rt5raaaa',
      revision: undefined,
      version: undefined
    })
    expect(
      getComponentURL({
        src: 'https://feaaslocal.blob.core.windows.net/components/2rFkpifWzZp5IEhKX4rt5raaaa/bkpRNHFB2v'
      })
    ).toEqual(
      'https://feaaslocal.blob.core.windows.net/components/2rFkpifWzZp5IEhKX4rt5raaaa/bkpRNHFB2v/responsive/published.html'
    )
    ;[
      'library/component',
      'cdn/components/library/component',
      'https://cdn/components/library/component',
      '//cdn/components/library/component',
      'cdn/components/library/component/version',
      'cdn/components/library/component/version/1',
      'library/component/version/1',
      'https://feaaslocal.blob.core.windows.net/components/library/component/version/1',
      'https://feaaslocal.blob.core.windows.net/components/2rFkpifWzZp5IEhKX4rt5raaaa/bkpRNHFB2v'
    ].forEach((expression) => {
      expect(getComponentSource(parseComponentSource(expression))).toEqual(expression)
    })
    expect(getComponentSource(parseComponentSource('library/component/version/12.html'))).toEqual(
      'library/component/version/12'
    )
    expect(getComponentSource(parseComponentSource('library/component/version/1'))).toEqual(
      'library/component/version/1'
    )
    expect(parseComponentSource('library/component/version/z.html')).toEqual(undefined)
    expect(parseComponentSource('library/component/version/z')).toEqual(undefined)
    expect(
      parseComponentSource('https://feaaslocal.blob.core.windows.net/components/library/component/version/1.html')
    ).toEqual({
      cdn: 'https://feaaslocal.blob.core.windows.net',
      component: 'component',
      library: 'library',
      revision: '1',
      version: 'version'
    })
    expect(parseComponentSource('library/component')).toEqual({
      cdn: undefined,
      component: 'component',
      library: 'library',
      revision: undefined,
      version: undefined
    })
    expect(
      getComponentSource(parseComponentSource(DEFAULT_CDN_URL + '/components/library/component/version/1.html'))
    ).toEqual('library/component/version/1')
    expect(getComponentSource(parseComponentSource('//cdn/components/library/component/version/1.html'))).toEqual(
      '//cdn/components/library/component/version/1'
    )
    expect(
      getComponentSource(
        parseComponentSource(DEFAULT_CDN_URL + '/components/library/component/responsive/published.html')
      )
    ).toEqual('library/component')
  })
  it('should parse and serialize stylesheet src', function () {
    expect(
      getStylesheetURL(
        parseStylesheetSource('https://feaaslocal.blob.core.windows.net/components/library/component/version/1')
      )
    ).toEqual('https://feaaslocal.blob.core.windows.net/styles/library/published.css')
    expect(
      getStylesheetSource(
        parseStylesheetSource('https://feaaslocal.blob.core.windows.net/components/library/component/version')
      )
    ).toEqual('https://feaaslocal.blob.core.windows.net/styles/library')
    expect(
      getStylesheetSource(
        parseStylesheetSource('https://feaaslocal.blob.core.windows.net/components/library/component')
      )
    ).toEqual('https://feaaslocal.blob.core.windows.net/styles/library')
    expect(getStylesheetURL(parseStylesheetSource('library/component'))).toEqual(
      DEFAULT_CDN_URL + '/styles/library/published.css'
    )
    expect(parseStylesheetSource('library/1')).toEqual({
      cdn: undefined,
      library: 'library',
      revision: '1'
    })
    expect(parseStylesheetSource('library/published')).toEqual({
      cdn: undefined,
      library: 'library',
      revision: 'published'
    })
    expect(parseStylesheetSource('library/component')).toEqual({
      cdn: undefined,
      library: 'library',
      revision: undefined
    })
    expect(parseStylesheetSource('library')).toEqual({
      cdn: undefined,
      library: 'library',
      revision: undefined
    })
    expect(getStylesheetSource(parseStylesheetSource('library/component/version'))).toEqual('library')
    expect(
      getStylesheetSource(
        parseStylesheetSource('https://feaaslocal.blob.core.windows.net/styles/clean-demo/published.css')
      )
    ).toEqual('https://feaaslocal.blob.core.windows.net/styles/clean-demo')
    expect(
      getStylesheetSource(parseStylesheetSource('//feaaslocal.blob.core.windows.net/styles/clean-demo/published.css'))
    ).toEqual('//feaaslocal.blob.core.windows.net/styles/clean-demo')
    expect(getStylesheetURL('clean-demo')).toEqual(DEFAULT_CDN_URL + '/styles/clean-demo/published.css')
    expect(getStylesheetURL('https://feaaslocal.blob.core.windows.net/styles/clean-demo')).toEqual(
      'https://feaaslocal.blob.core.windows.net/styles/clean-demo/published.css'
    )
    expect(getStylesheetURL('https://feaaslocal.blob.core.windows.net/styles/clean-demo/published.css')).toEqual(
      'https://feaaslocal.blob.core.windows.net/styles/clean-demo/published.css'
    )
  })
})
